@using System.Configuration;
@using DataStoreLib.Storage;

@{
    ViewBag.Title = "_MovieMirchiLayout";
}

@{
    Layout = null;
}




<!DOCTYPE html>

<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movie Mirchi</title>
    @Styles.Render("~/Content/bootstrap.min.css")
    @Styles.Render("~/Content/bootstrap.css")
    @Styles.Render("~/Content/style.css")
    @*@Styles.Render("~/Content/movie.style.css")*@
    @Scripts.Render("~/Content/bootstrap.min.js")
    @Scripts.Render("~/Scripts/jquery-1.8.3.min.js")
    @Scripts.Render("~/Scripts/jquery.cycle2.min.js")
    @Scripts.Render("~/Content/movie.core.js")
    @*@Scripts.Render("~/Content/movie.autocomplete.js")*@
</head>
<body>

    <div id="page">
        <div class="page-container">
            <div class="header">
                <div class="top-navigation">
                    <div class="logo">
                        Movie Mirchi
                    </div>
                    <div class="search-bar">
                        <div class="component">
                            <div class="dropdown">
                                <a data-toggle="dropdown" href="#">All <b class="caret"></b></a>
                                <ul class="dropdown-menu" role="menu" aria-labelledby="dLabel">
                                    <li><a href="#">All</a></li>
                                    <li><a href="#">Titles</a></li>
                                    <li><a href="#">Characters</a></li>
                                    <li><a href="#">Names</a></li>
                                </ul>
                            </div>
                        </div>
                        <div class="component">
                            <div id="targetDiv">
                                <input type="text" class="form-control" style="width: 204%;" placeholder="Search..." id="target" name="query" value="" autocomplete="off">
                            </div>
                            @*<input type="text" class="form-control" placeholder="Search..." id="target" name="query"
                                value="" />*@
                        </div>
                    </div>
                    <div class="top-navlinks">
                        <ul>

                            @if (Session["username"] != null)
                            {
                                <li class="authenticate">
                                    <input type="hidden" id="hfUserId" value="@Session["userid"]" />

                                    Welcome, @Session["username"].ToString().ToUpper()
                                </li>
                                <li id="profile"><a>Profile</a></li>
                                <li id="logout">
                                    @Html.ActionLink("LogOut", "Logout", "Login", null, new { @id = "auth_logoutlink" })

                                </li>

                            }
                            else
                            {
                                <li onclick="javascript:$('#sign-up').fadeIn(500);ShowHideFav('none');void(0);">
                                    <input type="hidden" id="hfUserId" value="" />
                                    <a>
                                        Sign up
                                    </a>
                                </li>
                                <li onclick="javascript:$('#login').fadeIn(500);ShowHideFav('none');void(0);"><a>Login</a></li>
                                <li class="fav" onclick="javascript: void (0);"><a onclick="ClearUserFavoriteControls();">Favorites</a></li>
                            }
                            
                        </ul>
                    </div>
                </div>
            </div>



            <div class="user-fav" style="overflow: overlay !important">
                <div class="alert alert-danger" style="display:none" id="favStatus"></div>
                <div class="fav-actors" title="Popular actors/actress on movie mirchi">
                    <div class="fav-title">
                        Actors
                    </div>
                    <div class="fav-content" id="fav_actor">
                    </div>
                </div>
                <div class="fav-actors" title="Popular directors on movie mirchi">
                    <div class="fav-title">
                        Directors
                    </div>
                    <div class="fav-content" id="fav_director">
                    </div>
                </div>
                <div class="fav-actors" title="Popular music directors on movie mirchi">
                    <div class="fav-title">
                        Music Directors
                    </div>
                    <div class="fav-content" id="fav_musicdirector">
                    </div>
                </div>
                <div class="fav-actors">
                    <div class="fav-title">
                        Genre
                    </div>
                    <div class="fav-content" id="fav_genre">
                        <span>
                            <input type="checkbox" id="chkAction" /><label for="chkAction">Action</label>
                        </span> <span>
                            <input type="checkbox" id="chkComedy" /><label for="chkComedy">Comedy</label>
                        </span> <span>
                            <input type="checkbox" id="chkDrama" /><label for="chkDrama">Drama</label>
                        </span> <span>
                            <input type="checkbox" id="chkRomance" /><label for="chkRomance">Romance</label>
                        </span>
                    </div>
                </div>
                <div class="buttons" style="right: 48%;">
                    <div class="btn btn-success" onclick="SaveUserFavorite();">
                        Save
                    </div>
                    <div class="btn" onclick='$(".user-fav").slideToggle("slow"), ClearUserFavoriteControls();'>
                        @*onclick="ShowHideFav('none');"*@
                        Close
                    </div>
                </div>
            </div>
        </div>
    </div>

    @RenderBody()

    <div id="footer">
        &copy; 2014. Movie Mirchi
    </div>

    <div id="modal" style="display: none">
        <div class="background">
        </div>
        <div id="login" style="display: none" class="modal-content">
            <div class="modal-header-content">
                Log in
            </div>
            <div class="modal-content-container">

                @if (Session["username"] == null)
                {

                <!--Fb Login Srcipt-->
                    <div id="fb-root"></div>
                        <!--Fb Login Srcipt-->
                    <script>
                        window.userFields = {
                            UserId: "@(Session["userid"] != null ? Session["userid"] : "")",
                            UserType: "@(Session["type"] != null ? Session["type"] : "")",
                            FirstName: "@(Session["firstname"] != null ? Session["firstname"] : "")",
                            LastName: "@(Session["lastname"] != null ? Session["lastname"] : "")",
                            Email: "@(Session["email"] != null ? Session["email"] : "")",
                            Mobile: "@(Session["mobile"] != null ? Session["mobile"] : "")",
                            DateOfBirth: "@(Session["dob"] != null ? Session["dob"] : "")",
                            Gender: "@(Session["gender"] != null ? Session["gender"] : "")",
                            City: "@(Session["city"] != null ? Session["city"] : "")",
                            Profile_Pic_Http: "@(Session["profile_pic"] != null ? Session["profile_pic"] : "")",
                            Profile_Pic_Https: "@(Session["profile_pic_https"] != null ? Session["profile_pic_https"] : "")",
                            Country: "@(Session["country"] != null ? Session["country"] : "")",
                            accessToken: "@(Session["fb_access_token"] != null ? Session["fb_access_token"] : "")"
                        };


                        window.fbAsyncInit = function () {
                            FB.init({
                                appId: '@ConfigurationManager.AppSettings["FacebookAppId"]',
                                status: true, // check login status
                                cookie: true, // enable cookies to allow the server to access the session
                                xfbml: true  // parse XFBML
                            });

                            // Here we subscribe to the auth.authResponseChange JavaScript event. This event is fired
                            // for any authentication related change, such as login, logout or session refresh. This means that
                            // whenever someone who was previously logged out tries to log in again, the correct case below
                            // will be handled.
                            FB.Event.subscribe('auth.authResponseChange', function (response) {
                                // Here we specify what we do with the response anytime this event occurs.
                                if (response.status === 'connected') {
                                    // The response object is returned with a status field that lets the app know the current
                                    // login status of the person. In this case, we're handling the situation where they
                                    // have logged in to the app.
                                    //testAPI();
                                    var uid = response.authResponse.userID;
                                    var accessToken = response.authResponse.accessToken;
                                    //fbLogin();
                                    testAPI(response);
                                } else if (response.status === 'not_authorized') {
                                    // In this case, the person is logged into Facebook, but not into the app, so we call
                                    // FB.login() to prompt them to do so.
                                    // In real-life usage, you wouldn't want to immediately prompt someone to login
                                    // like this, for two reasons:
                                    // (1) JavaScript created popup windows are blocked by most browsers unless they
                                    // result from direct interaction from people using the app (such as a mouse click)
                                    // (2) it is a bad experience to be continually prompted to login upon page load.
                                    //FB.login();
                                    //fbLogin();
                                    testAPI(response);
                                } else {
                                    // In this case, the person is not logged into Facebook, so we call the login()
                                    // function to prompt them to do so. Note that at this stage there is no indication
                                    // of whether they are logged into the app. If they aren't then they'll see the Login
                                    // dialog right after they log in to Facebook.
                                    // The same caveats as above apply to the FB.login() call here.
                                    //FB.login();
                                    //fbLogin();
                                    testAPI(response);
                                    //FB.logout(); made by me
                                    //fblogout(); made by me
                                }
                            });
                        };

                        // Load the SDK asynchronously
                        (function (d) {
                            var js, id = 'facebook-jssdk', ref = d.getElementsByTagName('script')[0];
                            if (d.getElementById(id)) { return; }
                            js = d.createElement('script'); js.id = id; js.async = true;
                            js.src = "//connect.facebook.net/en_US/all.js";
                            ref.parentNode.insertBefore(js, ref);
                        }(document));

                        // Here we run a very simple test of the Graph API after login is successful.
                        // This testAPI() function is only called in those cases.
                        function testAPI(response) {
                            //console.log('Welcome!  Fetching your information.... ');

                            accessToken = "";
                            accessToken = response.authResponse.accessToken;

                            FB.api('/me', function (response) {
                                //console.log(response);
                                //console.log('Good to see you, ' + response.name + '.');

                                userFields.UserId = response.id;
                                userFields.UserType = "facebook";
                                userFields.FirstName = response.first_name;
                                userFields.LastName = response.last_name;
                                userFields.Email = response.email;
                                userFields.Mobile = "";
                                userFields.DateOfBirth = response.birthday;
                                userFields.Gender = response.gender;
                                userFields.City = "";
                                userFields.Profile_Pic_Http = "http://graph.facebook.com/" + response.id + "/picture?type=large";
                                userFields.Profile_Pic_Https = "https://graph.facebook.com/" + response.id + "/picture?type=large";
                                userFields.Country = accessToken; // since we do not want to make major changes, posting access token in country field
                                connectUser();
                            });
                        }

                        var accessToken;
                        var fbLogin = function () {

                            FB.login(function (response) {

                                if (response.authResponse) {
                                    //$('#cboxClose').trigger('click');
                                    accessToken = "";
                                    accessToken = response.authResponse.accessToken;

                                    $(window).colorbox.close();
                                    //console.log('Welcome!  Fetching your information.... ');
                                    if (response.status === 'connected') {
                                        loginStatus = true;

                                        FB.api('/me', function (response) {
                                            //console.log(response);
                                            //console.log('Good to see you, ' + response.name + '.');

                                            //alert(response.name);

                                            userFields.UserId = response.id;
                                            userFields.UserType = "facebook";
                                            userFields.FirstName = response.first_name;
                                            userFields.LastName = response.last_name;
                                            userFields.Email = response.email;
                                            userFields.Mobile = "";
                                            userFields.DateOfBirth = response.birthday;
                                            userFields.Gender = response.gender;
                                            userFields.City = "";
                                            userFields.Profile_Pic_Http = "http://graph.facebook.com/" + response.id + "/picture?type=large";
                                            userFields.Profile_Pic_Https = "https://graph.facebook.com/" + response.id + "/picture?type=large";
                                            userFields.Country = accessToken; // since we do not want to make major changes, posting access token in country field
                                            connectUser();
                                        });
                                    }
                                } else {
                                    //console.log('User cancelled login or did not fully authorize.');
                                }
                            }, { scope: 'email,user_about_me,user_birthday,user_website,publish_actions' });
                        }

                        window.connectUser = function () {
                            $.post("@Url.Action("ConnectUser", "Login")", userFields, function (response) {
                                console.log(2);
                                if (response.success == true) {
                                    $('#login').hide();
                                    $('#logout').show();
                                    if (/iPhone/i.test(navigator.userAgent)) {
                                        location.reload(true);
                                    }
                                    location.reload(true);
                                }
                            }, 'json');
                        }

                    </script>

                    <!--
                    Below we include the Login Button social plugin. This button uses the JavaScript SDK to
                    present a graphical Login button that triggers the FB.login() function when clicked. -->

                }
                <span class="text-container">

                    <fb:login-button show-faces="false" size="large" max-rows="1" width="500">
                        Login with Facebook
                    </fb:login-button>
                </span>



                <div class="signup-or-separator">
                    <h6 class="text shift text-special">
                        or
                    </h6>
                </div>

                <div class="Record">
                    <div class="Column2">
                        <div class="signup-or-separator">
                            <div class="alert alert-danger" id="loginError" style="display: none"></div>
                        </div>
                    </div>
                </div>


                @using (Html.BeginForm())
                {
                    <div class="control-group row-space-1">
                        <input class="decorative-input" id="signin_email" name="email" placeholder="Email Address"
                               type="email">
                    </div>
                    <div class="control-group row-space-2">
                        <input class="decorative-input" id="signin_password" name="password" placeholder="Password"
                               type="password">
                    </div>


                    <div class="clearfix row-space-2">
                        <label for="remember_me2" class="checkbox remember-me">
                            <input type="checkbox" name="remember_me" id="remember_me2" value="true" class="remember_me">
                            Remember me
                        </label>
                        <a href="/forgot_password" class="forgot-password">Forgot password?</a>
                    </div>


                    <div class="Record">
                        <div class="Column2">


                            <div id="popup-auth" class="btn btn-block btn-success" onclick="authenticateUser();">Login</div>
                            @Html.Hidden("hfLogin", "")
                        </div>
                    </div>


                }

                <hr />
                <div class="sign-up-link">
                    Don't have an account?<a onclick="ShowWindow('#sign-up');">Sign up</a>
                </div>
            </div>

        </div>

        <div id="sign-up" style="display: none" class="modal-content">
            <div class="modal-header-content">
                Sign up
            </div>
            <div class="modal-content-container">
                <div class="fb-login">
                    <span class="text-container">Sign up with Facebook </span>
                </div>
                <div class="signup-or-separator">
                    <h6 class="text shift text-special">
                        or
                    </h6>
                </div>
                <div class="sign-up-link">
                    <a onclick="ShowWindow('#sign-up-email')" style="margin: 0px;">
                        Sign up with Email
                    </a>
                </div>
                <div class="terms">
                    By signing up, I agree to MovieMirchi's <a>Terms of Service</a> and <a>Privacy Policy</a>.
                </div>
                <hr class="separator" />
                <div class="sign-up-link">
                    Already a member?<a onclick="ShowWindow('#login');">Sign in</a>
                </div>
            </div>
        </div>

        <div id="sign-up-email" style="display: none" class="modal-content">
            <div class="modal-header-content">
                Sign up
            </div>
            <div class="modal-content-container">
                <div class="fb-login">
                    <span class="text-container">Sign up with Facebook </span>
                </div>
                <div class="signup-or-separator">
                    <h6 class="text shift text-special">
                        or
                    </h6>
                </div>

                <div class="signup-or-separator">
                    <div class="alert alert-danger" id="registerError" style="display: none"></div>
                    <div class="alert alert-success" id="successStatusR" style="display: none"></div>
                </div>



                @using (Html.BeginForm())
                {
                    <div class="control-group row-space-1">
                        <input class="decorative-input" id="FirstName" name="firstname" placeholder="First Name"
                               type="text">
                    </div>
                    <div class="control-group row-space-1">
                        <input class="decorative-input" id="LastName" name="lastname" placeholder="Last Name"
                               type="text">
                    </div>
                    <div class="control-group row-space-1">
                        <input class="decorative-input" id="Email1" name="email" placeholder="Email Address"
                               type="email">
                    </div>
                    <div class="control-group row-space-2">
                        <input class="decorative-input" id="password2" name="password" placeholder="Password"
                               type="password">
                    </div>
                    <div class="control-group row-space-2">
                        <input class="decorative-input" id="password3" name="password" placeholder="Retype Password"
                               type="password">
                    </div>
                    <div class="clearfix row-space-2">
                        <label for="remember_me2" class="checkbox remember-me">
                            <input type="checkbox" name="news" id="chkNews" value="true" class="remember_me">
                            Send me MovieMirchi Updates
                        </label>
                    </div>

                    <div class="Record">
                        <div class="Column2">

                            <div class="btn btn-block btn-success" id="popup-auth" onclick="RegisterUser();">Sign up</div>
                            @Html.Hidden("userJson", "")
                        </div>
                    </div>


                }


                <div class="terms">
                    By signing up, I agree to MovieMirchi's <a>Terms of Service</a> and <a>Privacy Policy</a>.
                </div>
                <hr class="separator" />
                <div class="sign-up-link">
                    Already a member?<a onclick="ShowWindow('#login');">Sign in</a>
                </div>
            </div>
        </div>

    </div>

</body>


</html>


<script type="text/javascript">
    $(".top-navlinks li").click(function () {
        if ($(this).attr("class") != "fav" && (($(this).attr("id") != "profile" && $(this).attr("id") != "logout") || $(this).attr("id") == undefined)) {
            $("#modal").show();
        }
    });

    $("#modal").click(function () {
        $(this).hide();
        $('#sign-up').hide();
        $('#login').hide();
    });

    $("#login").click(function (e) {
        e.stopPropagation();
    });

    $("#sign-up").click(function (e) {
        e.stopPropagation();
    });

    $("#sign-up-email").click(function (e) {
        e.stopPropagation();
    });

    function ShowWindow(id) {
        $('#sign-up').hide();
        $('#login').hide();
        $('#sign-up-email').hide();
        //$(".fav").click();
        $(id).show();
    }

    $(document).ready(function () {
        $('.banner').cycle({
            fx: 'fade' // choose your transition type, ex: fade, scrollUp, shuffle, etc...
        });

        $(".fav").click(function () {
            $(".user-fav").slideToggle("slow");
        });


        PopulatingUserFavorite();

    });


    function ShowHideFav(display) {
        $(".user-fav").css("display", display);
    }



</script>
